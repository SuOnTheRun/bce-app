<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Behavioral Context Engine</title>

  <style>
    :root{
      --bg:#07090c;
      --panel:#0c1016;
      --panel2:#0a0d12;
      --border:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --faint:rgba(255,255,255,.45);
      --accent:rgba(255,255,255,.12);
      --btn:rgba(255,255,255,.06);
      --btn2:rgba(255,255,255,.10);
      --good:#6ee7b7;
      --bad:#fb7185;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 30% -10%, rgba(255,255,255,.06), transparent 60%),
                  radial-gradient(900px 500px at 80% 10%, rgba(255,255,255,.04), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:28px 18px 42px;
    }
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom:18px;
    }
    .title{
      font-size:28px;
      letter-spacing:.2px;
      margin:0;
      line-height:1.15;
    }
    .subtitle{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:linear-gradient(to bottom, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--text);
      border-radius:12px;
      font-size:13px;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      transition:transform .05s ease, background .15s ease;
      white-space:nowrap;
    }
    .btn:hover{background:linear-gradient(to bottom, rgba(255,255,255,.09), rgba(255,255,255,.04))}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(to bottom, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border-color:rgba(255,255,255,.16);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1.25fr;
      gap:18px;
      align-items:start;
    }
    @media(max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(to bottom, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .sectionTitle{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
      margin:0 0 10px;
    }

    label.label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:12px 0 6px;
    }
    .input, textarea, select{
      width:100%;
      border:1px solid var(--border);
      background:rgba(0,0,0,.20);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:76px; resize:vertical}
    .input:focus, textarea:focus, select:focus{
      border-color:rgba(255,255,255,.18);
      box-shadow:0 0 0 3px rgba(255,255,255,.05);
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media(max-width: 520px){
      .row2{grid-template-columns:1fr}
    }

    .divider{
      height:1px;
      background:var(--border);
      margin:14px 0;
    }

    .errorBox{
      border:1px solid rgba(251,113,133,.35);
      background:rgba(251,113,133,.08);
      color:rgba(255,255,255,.9);
      padding:12px;
      border-radius:14px;
      font-size:13px;
      white-space:pre-wrap;
      margin-bottom:14px;
    }

    .outputTitle{
      font-size:16px;
      margin:0 0 10px;
      letter-spacing:.2px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:13px;
      line-height:1.55;
      white-space:pre-wrap;
      word-wrap:break-word;
      color:rgba(255,255,255,.88);
    }

    .pill{
      display:inline-flex;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      font-size:12px;
      color:var(--muted);
      margin-right:6px;
      margin-top:6px;
    }

    details{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(0,0,0,.18);
      margin-top:12px;
    }
    summary{
      cursor:pointer;
      color:var(--muted);
      font-size:13px;
      user-select:none;
    }
    .smallMuted{
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .hr{
      border:none;
      height:1px;
      background:var(--border);
      margin:12px 0;
    }

    .footerNote{
      margin-top:10px;
      color:var(--faint);
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 class="title">Behavioral Context Engine</h1>
        <div class="subtitle">Strategy-owned. One-page briefs. Decision-grade clarity.</div>
      </div>

      <div class="actions">
        <a class="btn" href="/library">Case Library</a>
        <a class="btn" href="/template">Download Excel Template</a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: INPUTS -->
      <div class="card">
        <div class="sectionTitle">Inputs</div>

        {% if error %}
          <div class="errorBox">{{ error }}</div>
        {% endif %}

        <form method="post" action="/generate" enctype="multipart/form-data">

          <label class="label">Excel (optional)</label>
          <input class="input" type="file" name="excel" accept=".xlsx"/>

          <div class="divider"></div>

          <label class="label">Category *</label>
          <input class="input" name="category" placeholder="Retail" value=""/>

          <label class="label">Objective *</label>
          <input class="input" name="objective" placeholder="Drive in-store footfall during promo window" value=""/>

          <label class="label">Channels *</label>
          <input class="input" name="channels" placeholder="DOOH, Display" value=""/>

          <label class="label">Market *</label>
          <input class="input" name="market" placeholder="US – NYC" value=""/>

          <div class="row2">
            <div>
              <label class="label">Flight Dates</label>
              <input class="input" name="flight_dates" placeholder="Jan 15 – Feb 10" value=""/>
            </div>
            <div>
              <label class="label">Measurement Type</label>
              <input class="input" name="measurement_type" placeholder="Footfall / BLS / Brand Lift" value=""/>
            </div>
          </div>

          <label class="label">Audience Logic *</label>
          <textarea name="audience_logic" class="input" placeholder="Plain English. No targeting jargon."></textarea>

          <label class="label">Creative Notes</label>
          <textarea name="creative_notes" class="input" placeholder="What it said, what it looked like. Keep debranded."></textarea>

          <div class="row2">
            <div>
              <label class="label">Key Result</label>
              <input class="input" name="key_result" placeholder="Store visits / lift / CPA target" value=""/>
            </div>
            <div>
              <label class="label">POI Context</label>
              <input class="input" name="poi_context" placeholder="Transit-adjacent stores, malls, high-street etc." value=""/>
            </div>
          </div>

          <label class="label">Notes</label>
          <textarea name="notes" class="input" placeholder="Any caveats, constraints, or internal context."></textarea>

          <div class="divider"></div>

          <div class="smallMuted">Optional discriminators (if blank, engine will infer):</div>

          <label class="label">Decision Type</label>
          <input class="input" name="decision_type" placeholder="Impulse capture / Planned consideration / Risk mitigation / Habit reinforcement / Identity signaling" value=""/>

          <label class="label">Primary Tension</label>
          <input class="input" name="primary_tension" placeholder="Time vs Value / Certainty vs Opportunity / Effort vs Reward / Identity vs Price" value=""/>

          <label class="label">Decision Window</label>
          <input class="input" name="decision_window" placeholder="At-threshold / Reflective / Pre-planned" value=""/>

          <div style="margin-top:14px;">
            <button class="btn primary" type="submit">Generate Brief</button>
          </div>

          <div class="footerNote">
            Keep inputs debranded. If LLM provider is offline, output uses internal fallback logic.
          </div>
        </form>
      </div>

      <!-- RIGHT: OUTPUT -->
      <div class="card">
        <div class="sectionTitle">Output</div>

        {% if output %}
          <h2 class="outputTitle">Behavioral Context Brief (BCB)</h2>

          {% if output.case_id %}
            <div class="smallMuted">Saved as <strong>Case #{{ output.case_id }}</strong></div>
          {% endif %}

          {% if output.headline %}
            <div style="margin-top:10px;">
              <div class="mono"><strong>Executive Decision Headline</strong>
{{ output.headline }}</div>
              {% if output.subhead %}
                <div class="smallMuted" style="margin-top:6px;">{{ output.subhead }}</div>
              {% endif %}
            </div>
            <div class="hr"></div>
          {% endif %}

          {% if output.dm %}
            <div style="margin-bottom:10px;">
              <span class="pill">Confidence: {{ output.dm.confidence_level or "Medium" }}</span>
              {% if output.provider %}
                <span class="pill">Provider: {{ output.provider }}</span>
              {% endif %}
              {% if output.models and output.models.pass_a %}
                <span class="pill">A: {{ output.models.pass_a }}</span>
              {% endif %}
              {% if output.models and output.models.pass_b %}
                <span class="pill">B: {{ output.models.pass_b }}</span>
              {% endif %}
            </div>
          {% endif %}

          {% if output.brief %}
            <div class="mono">{{ output.brief }}</div>
          {% endif %}

          {% if output.signals %}
            <div class="hr"></div>
            <div class="mono"><strong>Signals</strong></div>
            {% if output.signals.observed %}
              <div class="smallMuted" style="margin-top:6px;"><strong>Observed</strong></div>
              <div class="mono">- {{ output.signals.observed|join('\n- ') }}</div>
            {% endif %}
            {% if output.signals.inferred %}
              <div class="smallMuted" style="margin-top:10px;"><strong>Inferred</strong></div>
              <div class="mono">- {{ output.signals.inferred|join('\n- ') }}</div>
            {% endif %}
            {% if output.signals.hypothesis %}
              <div class="smallMuted" style="margin-top:10px;"><strong>Hypothesis</strong></div>
              <div class="mono">- {{ output.signals.hypothesis|join('\n- ') }}</div>
            {% endif %}
          {% endif %}

          {% if output.why_this_works %}
            <div class="hr"></div>
            <div class="mono"><strong>Why this works</strong></div>
            <div class="mono">- {{ output.why_this_works|join('\n- ') }}</div>
          {% endif %}

          {% if output.similar_cases %}
            <div class="hr"></div>
            <div class="mono"><strong>Similar Cases</strong></div>
            <div class="smallMuted">Pulled from your internal library. This is the compounding edge.</div>
            <div style="margin-top:10px;">
              {% for sc in output.similar_cases %}
                <div style="padding: 10px 0;">
                  <div>
                    <strong><a href="/library/{{ sc.id }}">Case #{{ sc.id }}</a></strong>
                    <span class="smallMuted"> • score {{ sc.similarity_score }}</span>
                  </div>
                  <div class="smallMuted">{{ sc.category }} • {{ sc.market }} • {{ sc.channels }}</div>
                  <div style="margin-top:6px;">
                    {% for r in sc.match_reasons %}
                      <span class="pill">{{ r }}</span>
                    {% endfor %}
                  </div>
                </div>
                <hr class="hr"/>
              {% endfor %}
            </div>
          {% endif %}

          <details>
            <summary>Show Decision Map JSON (internal)</summary>
            <div class="mono" style="margin-top:10px;">{{ output.decision_map_json }}</div>
          </details>

          {% if input_used %}
            <details>
              <summary>Show input used</summary>
              <div class="mono" style="margin-top:10px;">{{ input_used | tojson(indent=2) }}</div>
            </details>
          {% endif %}

        {% else %}
          <div class="mono">Generate a brief to see output here.</div>
        {% endif %}
      </div>
    </div>
  </div>
</body>
</html>
